import React, { useState, useEffect } from 'react';
import { Film, Tv, Plus, Edit2, Trash2, Save, X, Search, PlayCircle } from 'lucide-react';

const API_CONFIG = {
  githubToken: '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',
  githubUser: 'Demo-159',
  githubRepo: 'xtream-ui-server',
  omdbKey: '6c4c72eb' // API key gratuita de ejemplo
};

export default function XtreamAdminPanel() {
  const [activeTab, setActiveTab] = useState('movies');
  const [movies, setMovies] = useState([]);
  const [series, setSeries] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [editMode, setEditMode] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [loading, setLoading] = useState(false);
  const [currentItem, setCurrentItem] = useState(null);

  const emptyMovie = {
    stream_id: Date.now(),
    name: '',
    title: '',
    stream_icon: '',
    rating: '',
    plot: '',
    director: '',
    cast: '',
    genre: '',
    releaseDate: '',
    duration: '',
    direct_source: '',
    container_extension: 'mp4'
  };

  const emptySeries = {
    series_id: Date.now(),
    name: '',
    title: '',
    cover: '',
    plot: '',
    cast: '',
    director: '',
    genre: '',
    releaseDate: '',
    rating: '',
    seasons: []
  };

  const [formData, setFormData] = useState(emptyMovie);

  useEffect(() => {
    loadDataFromGithub();
  }, []);

  const loadDataFromGithub = async () => {
    setLoading(true);
    try {
      const response = await fetch(
        `https://api.github.com/repos/${API_CONFIG.githubUser}/${API_CONFIG.githubRepo}/contents/data.json`,
        {
          headers: {
            'Authorization': `token ${API_CONFIG.githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );
      
      if (response.ok) {
        const data = await response.json();
        const content = JSON.parse(atob(data.content));
        setMovies(content.movies || []);
        setSeries(content.series || []);
      }
    } catch (error) {
      console.error('Error loading data:', error);
    }
    setLoading(false);
  };

  const saveToGithub = async (newMovies, newSeries) => {
    setLoading(true);
    try {
      const getResponse = await fetch(
        `https://api.github.com/repos/${API_CONFIG.githubUser}/${API_CONFIG.githubRepo}/contents/data.json`,
        {
          headers: {
            'Authorization': `token ${API_CONFIG.githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );

      let sha = '';
      if (getResponse.ok) {
        const fileData = await getResponse.json();
        sha = fileData.sha;
      }

      const content = {
        movies: newMovies,
        series: newSeries,
        lastUpdated: new Date().toISOString()
      };

      const putResponse = await fetch(
        `https://api.github.com/repos/${API_CONFIG.githubUser}/${API_CONFIG.githubRepo}/contents/data.json`,
        {
          method: 'PUT',
          headers: {
            'Authorization': `token ${API_CONFIG.githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Update content - ${new Date().toLocaleString()}`,
            content: btoa(JSON.stringify(content, null, 2)),
            sha: sha
          })
        }
      );

      if (putResponse.ok) {
        alert('✅ Contenido guardado en GitHub exitosamente');
      } else {
        alert('❌ Error al guardar en GitHub');
      }
    } catch (error) {
      console.error('Error saving to GitHub:', error);
      alert('❌ Error al guardar: ' + error.message);
    }
    setLoading(false);
  };

  const searchOMDB = async () => {
    if (!searchQuery.trim()) return;
    
    setLoading(true);
    try {
      const isImdbId = searchQuery.startsWith('tt');
      const url = isImdbId 
        ? `https://www.omdbapi.com/?i=${searchQuery}&apikey=${API_CONFIG.omdbKey}&plot=full`
        : `https://www.omdbapi.com/?t=${encodeURIComponent(searchQuery)}&apikey=${API_CONFIG.omdbKey}&plot=full`;
      
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.Response === 'True') {
        if (activeTab === 'movies' && data.Type === 'movie') {
          setFormData({
            stream_id: formData.stream_id || Date.now(),
            name: data.Title,
            title: `${data.Title} (${data.Year})`,
            stream_icon: data.Poster !== 'N/A' ? data.Poster : '',
            rating: data.imdbRating || '',
            plot: data.Plot || '',
            director: data.Director || '',
            cast: data.Actors || '',
            genre: data.Genre || '',
            releaseDate: data.Released || '',
            duration: data.Runtime || '',
            direct_source: formData.direct_source || '',
            container_extension: 'mp4'
          });
        } else if (activeTab === 'series' && data.Type === 'series') {
          setFormData({
            series_id: formData.series_id || Date.now(),
            name: data.Title,
            title: data.Title,
            cover: data.Poster !== 'N/A' ? data.Poster : '',
            plot: data.Plot || '',
            cast: data.Actors || '',
            director: data.Director || '',
            genre: data.Genre || '',
            releaseDate: data.Released || '',
            rating: data.imdbRating || '',
            seasons: formData.seasons || []
          });
        } else {
          alert('⚠️ El tipo de contenido no coincide con la pestaña activa');
        }
      } else {
        alert('❌ No se encontró información: ' + data.Error);
      }
    } catch (error) {
      console.error('Error searching OMDB:', error);
      alert('❌ Error al buscar: ' + error.message);
    }
    setLoading(false);
  };

  const handleAdd = () => {
    setEditMode(false);
    setFormData(activeTab === 'movies' ? emptyMovie : emptySeries);
    setCurrentItem(null);
    setShowModal(true);
  };

  const handleEdit = (item) => {
    setEditMode(true);
    setCurrentItem(item);
    setFormData(item);
    setShowModal(true);
  };

  const handleDelete = async (id) => {
    if (!confirm('¿Estás seguro de eliminar este elemento?')) return;
    
    if (activeTab === 'movies') {
      const newMovies = movies.filter(m => m.stream_id !== id);
      setMovies(newMovies);
      await saveToGithub(newMovies, series);
    } else {
      const newSeries = series.filter(s => s.series_id !== id);
      setSeries(newSeries);
      await saveToGithub(movies, newSeries);
    }
  };

  const handleSave = async () => {
    if (!formData.name || !formData.title) {
      alert('⚠️ Por favor completa los campos obligatorios');
      return;
    }

    if (activeTab === 'movies') {
      let newMovies;
      if (editMode) {
        newMovies = movies.map(m => m.stream_id === formData.stream_id ? formData : m);
      } else {
        newMovies = [...movies, formData];
      }
      setMovies(newMovies);
      await saveToGithub(newMovies, series);
    } else {
      let newSeries;
      if (editMode) {
        newSeries = series.map(s => s.series_id === formData.series_id ? formData : s);
      } else {
        newSeries = [...series, formData];
      }
      setSeries(newSeries);
      await saveToGithub(movies, newSeries);
    }
    
    setShowModal(false);
    setFormData(activeTab === 'movies' ? emptyMovie : emptySeries);
  };

  const handleAddSeason = () => {
    const newSeason = {
      season_number: (formData.seasons?.length || 0) + 1,
      name: `Temporada ${(formData.seasons?.length || 0) + 1}`,
      episodes: []
    };
    setFormData({
      ...formData,
      seasons: [...(formData.seasons || []), newSeason]
    });
  };

  const handleAddEpisode = (seasonIndex) => {
    const seasons = [...formData.seasons];
    const newEpisode = {
      id: `${formData.series_id}_${seasonIndex + 1}_${(seasons[seasonIndex].episodes.length + 1)}`,
      episode_num: seasons[seasonIndex].episodes.length + 1,
      title: `Episodio ${seasons[seasonIndex].episodes.length + 1}`,
      direct_source: '',
      container_extension: 'mp4'
    };
    seasons[seasonIndex].episodes.push(newEpisode);
    setFormData({ ...formData, seasons });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
            Panel de Administración Xtream UI
          </h1>
          <p className="text-gray-400">Gestiona tu contenido VOD de manera sencilla</p>
        </div>

        {/* Tabs */}
        <div className="flex gap-4 mb-6">
          <button
            onClick={() => setActiveTab('movies')}
            className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${
              activeTab === 'movies'
                ? 'bg-purple-600 shadow-lg shadow-purple-500/50'
                : 'bg-gray-800 hover:bg-gray-700'
            }`}
          >
            <Film size={20} />
            Películas ({movies.length})
          </button>
          <button
            onClick={() => setActiveTab('series')}
            className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${
              activeTab === 'series'
                ? 'bg-purple-600 shadow-lg shadow-purple-500/50'
                : 'bg-gray-800 hover:bg-gray-700'
            }`}
          >
            <Tv size={20} />
            Series ({series.length})
          </button>
        </div>

        {/* Add Button */}
        <button
          onClick={handleAdd}
          disabled={loading}
          className="mb-6 flex items-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition-all shadow-lg disabled:opacity-50"
        >
          <Plus size={20} />
          Agregar {activeTab === 'movies' ? 'Película' : 'Serie'}
        </button>

        {/* Content List */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {(activeTab === 'movies' ? movies : series).map((item) => (
            <div
              key={item.stream_id || item.series_id}
              className="bg-gray-800 rounded-lg overflow-hidden shadow-xl hover:shadow-purple-500/20 transition-all"
            >
              <img
                src={item.stream_icon || item.cover || 'https://via.placeholder.com/300x450?text=No+Image'}
                alt={item.name}
                className="w-full h-64 object-cover"
              />
              <div className="p-4">
                <h3 className="font-bold text-lg mb-2 truncate">{item.name}</h3>
                <p className="text-sm text-gray-400 mb-3 line-clamp-2">{item.plot}</p>
                <div className="flex gap-2">
                  <button
                    onClick={() => handleEdit(item)}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition-all"
                  >
                    <Edit2 size={16} />
                    Editar
                  </button>
                  <button
                    onClick={() => handleDelete(item.stream_id || item.series_id)}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded transition-all"
                  >
                    <Trash2 size={16} />
                    Eliminar
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Modal */}
        {showModal && (
          <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
            <div className="bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div className="sticky top-0 bg-gray-800 p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 className="text-2xl font-bold">
                  {editMode ? 'Editar' : 'Agregar'} {activeTab === 'movies' ? 'Película' : 'Serie'}
                </h2>
                <button onClick={() => setShowModal(false)} className="text-gray-400 hover:text-white">
                  <X size={24} />
                </button>
              </div>

              <div className="p-6 space-y-4">
                {/* Search Box */}
                <div className="bg-gray-900 p-4 rounded-lg">
                  <label className="block text-sm font-medium mb-2">Buscar en OMDB (Nombre o ID de IMDb)</label>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      placeholder="Ej: The Matrix o tt0133093"
                      className="flex-1 bg-gray-800 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                    />
                    <button
                      onClick={searchOMDB}
                      disabled={loading}
                      className="px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded font-medium transition-all disabled:opacity-50 flex items-center gap-2"
                    >
                      <Search size={20} />
                      Buscar
                    </button>
                  </div>
                </div>

                {/* Form Fields */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Nombre *</label>
                    <input
                      type="text"
                      value={formData.name || ''}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Título *</label>
                    <input
                      type="text"
                      value={formData.title || ''}
                      onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                      className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">URL Imagen</label>
                    <input
                      type="text"
                      value={formData.stream_icon || formData.cover || ''}
                      onChange={(e) => setFormData({ ...formData, [activeTab === 'movies' ? 'stream_icon' : 'cover']: e.target.value })}
                      className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Calificación</label>
                    <input
                      type="text"
                      value={formData.rating || ''}
                      onChange={(e) => setFormData({ ...formData, rating: e.target.value })}
                      className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium mb-2">Sinopsis</label>
                    <textarea
                      value={formData.plot || ''}
                      onChange={(e) => setFormData({ ...formData, plot: e.target.value })}
                      rows="3"
                      className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Director</label>
                    <input
                      type="text"
                      value={formData.director || ''}
                      onChange={(e) => setFormData({ ...formData, director: e.target.value })}
                      className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Reparto</label>
                    <input
                      type="text"
                      value={formData.cast || ''}
                      onChange={(e) => setFormData({ ...formData, cast: e.target.value })}
                      className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Género</label>
                    <input
                      type="text"
                      value={formData.genre || ''}
                      onChange={(e) => setFormData({ ...formData, genre: e.target.value })}
                      className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Fecha de Estreno</label>
                    <input
                      type="text"
                      value={formData.releaseDate || ''}
                      onChange={(e) => setFormData({ ...formData, releaseDate: e.target.value })}
                      className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                    />
                  </div>
                  {activeTab === 'movies' && (
                    <>
                      <div>
                        <label className="block text-sm font-medium mb-2">Duración</label>
                        <input
                          type="text"
                          value={formData.duration || ''}
                          onChange={(e) => setFormData({ ...formData, duration: e.target.value })}
                          className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                        />
                      </div>
                      <div className="md:col-span-2">
                        <label className="block text-sm font-medium mb-2">URL de Video (Archive.org, etc.)</label>
                        <input
                          type="text"
                          value={formData.direct_source || ''}
                          onChange={(e) => setFormData({ ...formData, direct_source: e.target.value })}
                          placeholder="https://archive.org/download/..."
                          className="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:outline-none focus:border-purple-500"
                        />
                      </div>
                    </>
                  )}
                </div>

                {/* Seasons & Episodes (Series only) */}
                {activeTab === 'series' && (
                  <div className="mt-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold">Temporadas y Episodios</h3>
                      <button
                        onClick={handleAddSeason}
                        className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded flex items-center gap-2"
                      >
                        <Plus size={16} />
                        Agregar Temporada
                      </button>
                    </div>
                    
                    {formData.seasons?.map((season, seasonIdx) => (
                      <div key={seasonIdx} className="mb-4 bg-gray-900 p-4 rounded-lg">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="font-bold text-lg">{season.name}</h4>
                          <button
                            onClick={() => handleAddEpisode(seasonIdx)}
                            className="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm flex items-center gap-1"
                          >
                            <Plus size={14} />
                            Episodio
                          </button>
                        </div>
                        
                        {season.episodes?.map((episode, epIdx) => (
                          <div key={epIdx} className="mb-2 p-3 bg-gray-800 rounded">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                              <input
                                type="text"
                                value={episode.title}
                                onChange={(e) => {
                                  const seasons = [...formData.seasons];
                                  seasons[seasonIdx].episodes[epIdx].title = e.target.value;
                                  setFormData({ ...formData, seasons });
                                }}
                                placeholder="Título del episodio"
                                className="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm"
                              />
                              <input
                                type="text"
                                value={episode.direct_source}
                                onChange={(e) => {
                                  const seasons = [...formData.seasons];
                                  seasons[seasonIdx].episodes[epIdx].direct_source = e.target.value;
                                  setFormData({ ...formData, seasons });
                                }}
                                placeholder="URL del video"
                                className="md:col-span-2 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm"
                              />
                            </div>
                          </div>
                        ))}
                      </div>
                    ))}
                  </div>
                )}

                {/* Action Buttons */}
                <div className="flex gap-4 pt-4 border-t border-gray-700">
                  <button
                    onClick={handleSave}
                    disabled={loading}
                    className="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition-all disabled:opacity-50 flex items-center justify-center gap-2"
                  >
                    <Save size={20} />
                    {loading ? 'Guardando...' : 'Guardar'}
                  </button>
                  <button
                    onClick={() => setShowModal(false)}
                    className="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium transition-all"
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Loading Overlay */}
        {loading && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-gray-800 rounded-lg p-6 flex items-center gap-4">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
              <span>Cargando...</span>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
